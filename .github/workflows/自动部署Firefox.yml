name: è‡ªåŠ¨éƒ¨ç½²Firefoxåˆ°SAP

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'é€‰æ‹©éƒ¨ç½²åŒºåŸŸ'
        required: true
        default: 'US(free)'
        type: choice
        options:
          - SG(free)
          - US(free)
          - AWS-AU(Sydney)
          - AWS-BR(SÃ£o Paulo)
          - AWS-KR(Seoul)
          - AWS-CA(Montreal)
          - AWS-US(VA)
          - AWS-US(OR)
          - AWS-EU(Frankfurt)
          - AWS-JP(Tokyo)
          - AWS-SG(Singapore)
          - GCP-AU(Sydney)
          - GCP-BR(SÃ£o Paulo)
          - GCP-US(IA)
          - GCP-EU(Frankfurt)
          - GCP-JP(Osaka)
          - GCP-JP(Tokyo)
          - GCP-IL(Tel Aviv)
          - GCP-IN(Mumbai)
          - GCP-KSA(Dammam)
          - Azure-AU(Sydney)
          - Azure-BR(SÃ£o Paulo)
          - Azure-CA(Montreal)
          - Azure-US(VA)
          - Azure-US(WA)
          - Azure-EU(Netherlands)
          - Azure-JP(Tokyo)
          - Azure-SG(Singapore)
          - Neo-UAE(Dubai)
          - Neo-KSA(Riyadh)
      app_name:
        description: 'åº”ç”¨åç§°(å¯é€‰,ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        default: ''

env:
  DOCKER_IMAGE: 'mrcolorrain/vnc-browser:debian'
  MEMORY: ${{ secrets.MEMORY || '2048M' }}  # å¢åŠ åˆ° 2048Mï¼Œé¿å…èµ„æºä¸è¶³
  DISK: ${{ secrets.DISK || '1536M' }}

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    steps:
    - name: Install CF CLI and jq
      run: |
        wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
        echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
        sudo apt-get update
        sudo apt-get install -y cf8-cli jq

    - name: Determine CF API endpoint and app name
      run: |
        RANDOM_STR=$(head /dev/urandom | tr -dc 'a-z' | head -c 6)
        
        case "${{ github.event.inputs.region }}" in
          "SG(free)") CF_API="https://api.cf.ap21.hana.ondemand.com"; APP_PREFIX="freesg" ;;
          "US(free)") CF_API="https://api.cf.us10-001.hana.ondemand.com"; APP_PREFIX="freeus" ;;
          "AWS-AU(Sydney)") CF_API="https://api.cf.ap10.hana.ondemand.com"; APP_PREFIX="awsau" ;;
          "AWS-BR(SÃ£o Paulo)") CF_API="https://api.cf.br10.hana.ondemand.com"; APP_PREFIX="awsbr" ;;
          "AWS-KR(Seoul)") CF_API="https://api.cf.ap12.hana.ondemand.com"; APP_PREFIX="awskr" ;;
          "AWS-CA(Montreal)") CF_API="https://api.cf.ca10.hana.ondemand.com"; APP_PREFIX="awsca" ;;
          "AWS-US(VA)") CF_API="https://api.cf.us10-001.hana.ondemand.com"; APP_PREFIX="awsusva" ;;
          "AWS-US(OR)") CF_API="https://api.cf.us11.hana.ondemand.com"; APP_PREFIX="awsusor" ;;
          "AWS-EU(Frankfurt)") CF_API="https://api.cf.eu10-005.hana.ondemand.com"; APP_PREFIX="awseu" ;;
          "AWS-JP(Tokyo)") CF_API="https://api.cf.jp10.hana.ondemand.com"; APP_PREFIX="awsjp" ;;
          "AWS-SG(Singapore)") CF_API="https://api.cf.ap11.hana.ondemand.com"; APP_PREFIX="awssg" ;;
          "GCP-AU(Sydney)") CF_API="https://api.cf.ap30.hana.ondemand.com"; APP_PREFIX="gcpau" ;;
          "GCP-BR(SÃ£o Paulo)") CF_API="https://api.cf.br30.hana.ondemand.com"; APP_PREFIX="gcpbr" ;;
          "GCP-US(IA)") CF_API="https://api.cf.us30.hana.ondemand.com"; APP_PREFIX="gcpus" ;;
          "GCP-EU(Frankfurt)") CF_API="https://api.cf.eu30.hana.ondemand.com"; APP_PREFIX="gcpeu" ;;
          "GCP-JP(Osaka)") CF_API="https://api.cf.jp30.hana.ondemand.com"; APP_PREFIX="gcpjpo" ;;
          "GCP-JP(Tokyo)") CF_API="https://api.cf.jp31.hana.ondemand.com"; APP_PREFIX="gcpjpt" ;;
          "GCP-IL(Tel Aviv)") CF_API="https://api.cf.il30.hana.ondemand.com"; APP_PREFIX="gcpil" ;;
          "GCP-IN(Mumbai)") CF_API="https://api.cf.in30.hana.ondemand.com"; APP_PREFIX="gcpin" ;;
          "GCP-KSA(Dammam)") CF_API="https://api.cf.sa31.hana.ondemand.com"; APP_PREFIX="gcpsa" ;;
          "Azure-AU(Sydney)") CF_API="https://api.cf.ap20.hana.ondemand.com"; APP_PREFIX="azau" ;;
          "Azure-BR(SÃ£o Paulo)") CF_API="https://api.cf.br20.hana.ondemand.com"; APP_PREFIX="azbr" ;;
          "Azure-CA(Montreal)") CF_API="https://api.cf.ca20.hana.ondemand.com"; APP_PREFIX="azca" ;;
          "Azure-US(VA)") CF_API="https://api.cf.us21.hana.ondemand.com"; APP_PREFIX="azva" ;;
          "Azure-US(WA)") CF_API="https://api.cf.us20.hana.ondemand.com"; APP_PREFIX="azwa" ;;
          "Azure-EU(Netherlands)") CF_API="https://api.cf.eu20-001.hana.ondemand.com"; APP_PREFIX="azeu" ;;
          "Azure-JP(Tokyo)") CF_API="https://api.cf.jp20.hana.ondemand.com"; APP_PREFIX="azjp" ;;
          "Azure-SG(Singapore)") CF_API="https://api.cf.ap21.hana.ondemand.com"; APP_PREFIX="azsg" ;;
          "Neo-UAE(Dubai)") CF_API="https://api.cf.neo-ae1.hana.ondemand.com"; APP_PREFIX="neouae" ;;
          "Neo-KSA(Riyadh)") CF_API="https://api.cf.neo-sa1.hana.ondemand.com"; APP_PREFIX="neoksa" ;;
        esac
        
        echo "CF_API=$CF_API" >> $GITHUB_ENV
        if [ -z "${{ github.event.inputs.app_name }}" ]; then
          echo "APP_NAME=browser-$APP_PREFIX$RANDOM_STR" >> $GITHUB_ENV
        else
          echo "APP_NAME=${{ github.event.inputs.app_name }}" >> $GITHUB_ENV
        fi
        echo "Selected region: ${{ github.event.inputs.region }}, App: $APP_NAME, API: $CF_API"

    - name: Login to Cloud Foundry
      run: |
        cf login -a ${{ env.CF_API }} -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}" --skip-ssl-validation
        ORG=$(cf orgs | tail -n +4 | head -1 | xargs)
        SPACE=$(cf spaces | tail -n +4 | head -1 | xargs)
        if [ -z "$ORG" ] || [ -z "$SPACE" ]; then
          echo "âŒ Failed to detect org/space"
          exit 1
        fi
        cf target -o "$ORG" -s "$SPACE"
        echo "Logged in to org: $ORG, space: $SPACE"

    - name: Deploy application
      run: |
        if cf push ${{ env.APP_NAME }} \
          --docker-image ${{ env.DOCKER_IMAGE }} \
          -m ${{ env.MEMORY }} \
          -k ${{ env.DISK }} \
          --health-check-type process \
          --no-start; then
          echo "âœ… åº”ç”¨åˆ›å»ºæˆåŠŸ"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          exit 1
        fi

    - name: Set environment variables
      run: |
        # æ ¸å¿ƒä¿®å¤ï¼šé‡ç½® NOVNC ç«¯å£ï¼Œè®©é•œåƒ fallback åˆ° $PORTï¼›æ·»åŠ  websockify ç»‘å®šå˜é‡
        cf set-env ${{ env.APP_NAME }} NOVNC_PORT ""  # é‡ç½® noVNC ç«¯å£ï¼Œé»˜è®¤ç”¨ $PORT
        cf set-env ${{ env.APP_NAME }} WEBSOCKIFY_BIND "0.0.0.0"  # å…¨æ¥å£ç›‘å¬
        cf set-env ${{ env.APP_NAME }} WEBSOCKIFY_PORT "$PORT"  # å¼ºåˆ¶ websockify ä½¿ç”¨ $PORT
        cf set-env ${{ env.APP_NAME }} WEBSOCKIFY_TARGET "localhost:5900"  # VNC å†…éƒ¨ç›®æ ‡
        cf set-env ${{ env.APP_NAME }} VNC_PORT "5900"  # å†…éƒ¨ VNC ç«¯å£
        cf set-env ${{ env.APP_NAME }} VNC_PASSWORD "${{ secrets.VNC_PASSWORD || 'vncpass' }}"
        cf set-env ${{ env.APP_NAME }} VNC_RESOLUTION "${{ secrets.VNC_RESOLUTION || '1280x720' }}"
        cf set-env ${{ env.APP_NAME }} AUTO_START_BROWSER "true"
        cf set-env ${{ env.APP_NAME }} STARTING_WEBSITE_URL "https://www.google.com"
        cf restage ${{ env.APP_NAME }}  # åº”ç”¨å˜æ›´
        sleep 10  # ç­‰å¾… restage å®Œæˆ
        echo "âœ… ç¯å¢ƒå˜é‡è®¾ç½®å¹¶ restage å®Œæˆ"

    - name: Check Detailed Logs
      run: |
        sleep 5  # çŸ­æš‚ç­‰å¾…æ—¥å¿—ç”Ÿæˆ
        cf logs ${{ env.APP_NAME }} --recent | grep -E "(error|websockify|PORT|bind|502|VNC|Listening)" || echo "è­¦å‘Šï¼šæœªè§å…³é”®æ—¥å¿—ï¼Œå¯èƒ½éœ€è‡ªå®šä¹‰é•œåƒ"
        cf app ${{ env.APP_NAME }} | grep -E "(state|instances|ports|requested state)"

    - name: Start application
      run: |
        cf start ${{ env.APP_NAME }}
        sleep 20  # å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œè®© websockify å¯åŠ¨
        
        for i in {1..40}; do  # å»¶é•¿è¶…æ—¶åˆ° 200s
          STATUS=$(cf app ${{ env.APP_NAME }} --json | jq -r '.requested_state // empty' || echo "unknown")
          INSTANCES=$(cf app ${{ env.APP_NAME }} --json | jq -r '[.instances[] | select(.state == "RUNNING")] | length' || echo "0")
          
          echo "[$i/40] çŠ¶æ€: $STATUS, è¿è¡Œå®ä¾‹æ•°: $INSTANCES"
          
          if [ "$STATUS" = "STARTED" ] && [ "$INSTANCES" -gt 0 ]; then
            echo "âœ… æµè§ˆå™¨å¯åŠ¨æˆåŠŸ!"
            ROUTE=$(cf app ${{ env.APP_NAME }} | grep "routes:" | awk '{print $2}' | head -1 || echo "unknown")
            echo ""
            echo "ğŸŒ è®¿é—®åœ°å€: https://$ROUTE"
            echo "ğŸ” VNCå¯†ç : ${{ secrets.VNC_PASSWORD || 'vncpass' }}"
            echo ""
            echo "ğŸ’¡ æ‰“å¼€åœ°å€åç‚¹å‡»'è¿æ¥'æŒ‰é’®å³å¯ä½¿ç”¨æµè§ˆå™¨"
            # è¾“å‡ºå…³é”®æ—¥å¿—æ£€æŸ¥ websockify
            cf logs ${{ env.APP_NAME }} --recent | grep -E "(websockify|VNC|PORT|Listening)" || echo "è­¦å‘Šï¼šæœªè§ websockify ç»‘å®šæ—¥å¿—ï¼Œå¯èƒ½éœ€è‡ªå®šä¹‰é•œåƒ"
            exit 0
          fi
          
          if [ $i -eq 40 ]; then
            echo "âŒ å¯åŠ¨è¶…æ—¶"
            cf logs ${{ env.APP_NAME }} --recent
            cf events ${{ env.APP_NAME }}  # æ·»åŠ äº‹ä»¶æ—¥å¿—
            exit 1
          fi
          
          sleep 5
        done

    - name: Switch to HTTP Health Check
      if: always()  # å³ä½¿å¤±è´¥ä¹Ÿå°è¯•è®¾ç½®
      run: |
        cf set-health-check-type ${{ env.APP_NAME }} http --endpoint / || echo "å¥åº·æ£€æŸ¥è®¾ç½®å¤±è´¥"
        cf restage ${{ env.APP_NAME }} || echo "Restage å¤±è´¥"
        echo "åˆ‡æ¢åˆ° HTTP å¥åº·æ£€æŸ¥å®Œæˆ"
