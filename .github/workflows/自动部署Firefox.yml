name: è‡ªåŠ¨éƒ¨ç½²Chromiumåˆ°SAP

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'é€‰æ‹©éƒ¨ç½²åŒºåŸŸ'
        required: true
        default: 'US(free)'
        type: choice
        options:
          - SG(free)
          - US(free)
          - AWS-AU(Sydney)
          - AWS-BR(SÃ£o Paulo)
          - AWS-KR(Seoul)
          - AWS-CA(Montreal)
          - AWS-US(VA)
          - AWS-US(OR)
          - AWS-EU(Frankfurt)
          - AWS-JP(Tokyo)
          - AWS-SG(Singapore)
          - GCP-AU(Sydney)
          - GCP-BR(SÃ£o Paulo)
          - GCP-US(IA)
          - GCP-EU(Frankfurt)
          - GCP-JP(Osaka)
          - GCP-JP(Tokyo)
          - GCP-IL(Tel Aviv)
          - GCP-IN(Mumbai)
          - GCP-KSA(Dammam)
          - Azure-AU(Sydney)
          - Azure-BR(SÃ£o Paulo)
          - Azure-CA(Montreal)
          - Azure-US(VA)
          - Azure-US(WA)
          - Azure-EU(Netherlands)
          - Azure-JP(Tokyo)
          - Azure-SG(Singapore)
          - Neo-UAE(Dubai)
          - Neo-KSA(Riyadh)
      app_name:
        description: 'åº”ç”¨åç§°(å¯é€‰,ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        default: ''

env:
  DOCKER_IMAGE: 'mrcolorrain/vnc-browser:debian'
  MEMORY: ${{ secrets.MEMORY || '1024M' }}
  DISK: ${{ secrets.DISK || '1536M' }}
  CHROME_OPTS: '--headless --disable-gpu --no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-extensions --remote-debugging-port=9222'

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    steps:
    - name: å®‰è£… CF CLIï¼ˆç°ä»£åŒ–å¯†é’¥ç®¡ç†ï¼‰
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl -fSL https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.gpg | gpg --dearmor -o /usr/share/keyrings/cloudfoundry-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/cloudfoundry-archive-keyring.gpg] https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
        sudo apt-get update
        sudo apt-get install -y cf8-cli

    - name: è®¡ç®— CF API ä¸ App åç§°
      run: |
        RANDOM_STR=$(head /dev/urandom | tr -dc 'a-z' | head -c 6)
        case "${{ github.event.inputs.region }}" in
          "SG(free)") CF_API="https://api.cf.ap21.hana.ondemand.com"; APP_PREFIX="freesg" ;;
          "US(free)") CF_API="https://api.cf.us10-001.hana.ondemand.com"; APP_PREFIX="freeus" ;;
          "AWS-AU(Sydney)") CF_API="https://api.cf.ap10.hana.ondemand.com"; APP_PREFIX="awsau" ;;
          "AWS-BR(SÃ£o Paulo)") CF_API="https://api.cf.br10.hana.ondemand.com"; APP_PREFIX="awsbr" ;;
          "AWS-KR(Seoul)") CF_API="https://api.cf.ap12.hana.ondemand.com"; APP_PREFIX="awskr" ;;
          "AWS-CA(Montreal)") CF_API="https://api.cf.ca10.hana.ondemand.com"; APP_PREFIX="awsca" ;;
          "AWS-US(VA)") CF_API="https://api.cf.us10-001.hana.ondemand.com"; APP_PREFIX="awsusva" ;;
          "AWS-US(OR)") CF_API="https://api.cf.us11.hana.ondemand.com"; APP_PREFIX="awsusor" ;;
          "AWS-EU(Frankfurt)") CF_API="https://api.cf.eu10-005.hana.ondemand.com"; APP_PREFIX="awseu" ;;
          "AWS-JP(Tokyo)") CF_API="https://api.cf.jp10.hana.ondemand.com"; APP_PREFIX="awsjp" ;;
          "AWS-SG(Singapore)") CF_API="https://api.cf.ap11.hana.ondemand.com"; APP_PREFIX="awssg" ;;
          "GCP-AU(Sydney)") CF_API="https://api.cf.ap30.hana.ondemand.com"; APP_PREFIX="gcpau" ;;
          "GCP-BR(SÃ£o Paulo)") CF_API="https://api.cf.br30.hana.ondemand.com"; APP_PREFIX="gcpbr" ;;
          "GCP-US(IA)") CF_API="https://api.cf.us30.hana.ondemand.com"; APP_PREFIX="gcpus" ;;
          "GCP-EU(Frankfurt)") CF_API="https://api.cf.eu30.hana.ondemand.com"; APP_PREFIX="gcpeu" ;;
          "GCP-JP(Osaka)") CF_API="https://api.cf.jp30.hana.ondemand.com"; APP_PREFIX="gcpjpo" ;;
          "GCP-JP(Tokyo)") CF_API="https://api.cf.jp31.hana.ondemand.com"; APP_PREFIX="gcpjpt" ;;
          "GCP-IL(Tel Aviv)") CF_API="https://api.cf.il30.hana.ondemand.com"; APP_PREFIX="gcpil" ;;
          "GCP-IN(Mumbai)") CF_API="https://api.cf.in30.hana.ondemand.com"; APP_PREFIX="gcpin" ;;
          "GCP-KSA(Dammam)") CF_API="https://api.cf.sa31.hana.ondemand.com"; APP_PREFIX="gcpsa" ;;
          "Azure-AU(Sydney)") CF_API="https://api.cf.ap20.hana.ondemand.com"; APP_PREFIX="azau" ;;
          "Azure-BR(SÃ£o Paulo)") CF_API="https://api.cf.br20.hana.ondemand.com"; APP_PREFIX="azbr" ;;
          "Azure-CA(Montreal)") CF_API="https://api.cf.ca20.hana.ondemand.com"; APP_PREFIX="azca" ;;
          "Azure-US(VA)") CF_API="https://api.cf.us21.hana.ondemand.com"; APP_PREFIX="azva" ;;
          "Azure-US(WA)") CF_API="https://api.cf.us20.hana.ondemand.com"; APP_PREFIX="azwa" ;;
          "Azure-EU(Netherlands)") CF_API="https://api.cf.eu20-001.hana.ondemand.com"; APP_PREFIX="azeu" ;;
          "Azure-JP(Tokyo)") CF_API="https://api.cf.jp20.hana.ondemand.com"; APP_PREFIX="azjp" ;;
          "Azure-SG(Singapore)") CF_API="https://api.cf.ap21.hana.ondemand.com"; APP_PREFIX="azsg" ;;
          "Neo-UAE(Dubai)") CF_API="https://api.cf.neo-ae1.hana.ondemand.com"; APP_PREFIX="neouae" ;;
          "Neo-KSA(Riyadh)") CF_API="https://api.cf.neo-sa1.hana.ondemand.com"; APP_PREFIX="neoksa" ;;
        esac
        echo "CF_API=$CF_API" >> $GITHUB_ENV
        if [ -z "${{ github.event.inputs.app_name }}" ]; then
          echo "APP_NAME=browser-$APP_PREFIX$RANDOM_STR" >> $GITHUB_ENV
        else
          echo "APP_NAME=${{ github.event.inputs.app_name }}" >> $GITHUB_ENV
        fi

    - name: CF ç™»å½•
      run: |
        cf login -a ${{ env.CF_API }} -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
        ORG=$(cf orgs | sed -n '4p')
        SPACE=$(cf spaces | sed -n '4p')
        cf target -o "$ORG" -s "$SPACE"

    - name: éƒ¨ç½²åº”ç”¨
      run: |
        if cf push ${{ env.APP_NAME }} \
          --docker-image ${{ env.DOCKER_IMAGE }} \
          -m ${{ secrets.MEMORY || '1024M' }} \
          -k ${{ secrets.DISK || '1536M' }} \
          --health-check-type process \
          --no-start; then
          echo "âœ… åº”ç”¨åˆ›å»ºæˆåŠŸ"
        else
          cf delete ${{ env.APP_NAME }} -f 2>/dev/null || true
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          exit 1
        fi

    - name: å¯åŠ¨åº”ç”¨å¹¶è¾“å‡ºè®¿é—®åœ°å€
      run: |
        cf start ${{ env.APP_NAME }}
        sleep 15
        ROUTE=$(cf app ${{ env.APP_NAME }} | grep "routes:" | awk '{print $2}')
        echo "ğŸŒ è®¿é—®åœ°å€: https://$ROUTE"
        echo "ğŸ” VNCå¯†ç : ${{ secrets.VNC_PASSWORD || 'vncpass' }}"
